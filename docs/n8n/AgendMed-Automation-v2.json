{
  "name": "AgendMed - Assistente IA M√©dica",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1eec119-4e22-4e62-b575-6ccb913de655",
              "name": "telefone",
              "value": "={{ $json.body.data.key.remoteJid.split('@')[0] }}",
              "type": "string"
            },
            {
              "id": "9e89621d-db16-476d-922a-9761d37db78a",
              "name": "fromMe",
              "value": "={{ $json.body.data.key.fromMe }}",
              "type": "boolean"
            },
            {
              "id": "6ce700dd-bac5-4e5a-a58d-f1182d048723",
              "name": "isGroup",
              "value": "={{ $json.body.data?.message?.senderKeyDistributionMessage?.groupId ? true : false }}",
              "type": "boolean"
            },
            {
              "id": "7a746db9-0b49-4679-9d7a-dbee5cf7c3ee",
              "name": "nome",
              "value": "={{ $json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "0d7bf3c9-561c-445e-afbc-cd3d1a65d37a",
              "name": "nomeinstancia_evo",
              "value": "AgendMed",
              "type": "string"
            },
            {
              "id": "58512958-635c-4d26-a57b-b649c909e1a7",
              "name": "host_evo",
              "value": "https://evolution.devfraga.com",
              "type": "string"
            },
            {
              "id": "5378d2c4-6048-4069-a4e6-a36e760c2786",
              "name": "apikey_evo",
              "value": "={{ $json.body.apikey }}",
              "type": "string"
            },
            {
              "id": "ba41443e-9a7b-460c-aec0-683e0a043f87",
              "name": "delay",
              "value": "[1000, 2000, 700, 2500]",
              "type": "array"
            },
            {
              "id": "agendmed-api-url",
              "name": "agendmed_api_url",
              "value": "https://agend-med.vercel.app/api",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-2224, 80],
      "id": "7f3c8348-2209-4462-8a24-0896fb5bc9bb",
      "name": "global"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2bb556aa-953f-406e-b2d4-1f8dea4054b8",
              "leftValue": "={{ $json.fromMe }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "444e6b4c-2ef1-48af-a439-0031ce12cb8e",
              "leftValue": "={{ $json.isGroup }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-1984, 64],
      "id": "1f2368bd-3e76-427c-b186-136354f39275",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('global').item.json.agendmed_api_url }}/patients/find-or-create",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.AGENDMED_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phone\": \"{{ $('global').item.json.telefone }}\",\n  \"name\": \"{{ $('global').item.json.nome }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [-1600, 128],
      "id": "2409c7b8-e613-407f-b43a-6a677e191fc1",
      "name": "Buscar/Criar Paciente AgendMed"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e6b268ba-470d-405c-aa4f-500763b5260f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a999c4b1-e676-4261-9413-bb64841a9aa6",
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8bb6db5b-1708-4d20-b72e-08c51269e7a1",
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [-1200, 128],
      "id": "e946cfd1-9639-4ed2-91d7-6b071ff4e955",
      "name": "Tipo da Mensagem"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "agendmed-webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [-2464, 80],
      "id": "208d18b6-e78c-4480-9c89-7334ea08d3a8",
      "name": "Webhook",
      "webhookId": "agendmed-webhook-id"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.texto }}",
        "options": {
          "systemMessage": "=<systemData>\n  Data de hoje: {{ $now.toFormat('dd/MM/yyyy HH:mm:ss', { timezone: 'America/Sao_Paulo'}) }}\n</systemData>\n\n# Dados do Paciente\nNome: \"{{ $('global').item.json.nome }}\"\nTelefone: \"{{ $('global').item.json.telefone }}\"\n\n# PAPEL\nVoc√™ √© a Ana, assistente virtual do AgendMed, uma plataforma inovadora de agendamento m√©dico. Sua fun√ß√£o √© acolher pacientes pelo WhatsApp de forma humanizada, prestando informa√ß√µes sobre a plataforma, ajudando com agendamentos e suporte t√©cnico.\n\n**IMPORTANTE:** Seja concisa! M√°ximo 2-3 linhas por mensagem, como um humano faria no WhatsApp.\n\n# INSTRU√á√ïES\n\n## Etapa 1: Sauda√ß√£o e Apresenta√ß√£o\nEx: Oi! Sou a Ana do AgendMed üòä\n**Aten√ß√£o:** Caso usu√°rio apenas tenha mandado oi ou bom dia sem objetivo direto, responda: \"Como posso te ajudar?\"\n\n## Etapa 2: Identifica√ß√£o da Necessidade\n- Identifique se √© paciente ou m√©dico/cl√≠nica\n- Solicite o nome para personalizar o atendimento\n- Uma pergunta por vez\n\nEx:\n**Paciente:** Quero agendar uma consulta.\n**Ana:** Que √≥timo! Qual seu nome?\n\n## Etapa 3: Direcionamento por Tipo de Usu√°rio\n\n### Para Pacientes:\n- Explique como funciona o AgendMed\n- Ajude a encontrar m√©dicos/cl√≠nicas\n- Auxilie no processo de agendamento\n- Esclare√ßa d√∫vidas sobre consultas\n\n### Para M√©dicos/Cl√≠nicas:\n- Apresente os benef√≠cios da plataforma\n- Explique o processo de cadastro\n- Informe sobre planos e funcionalidades\n- Direcione para demonstra√ß√£o\n\n## Etapa 4: Suporte T√©cnico\n- Ajude com problemas de login\n- Esclare√ßa d√∫vidas sobre funcionalidades\n- Oriente sobre uso da plataforma\n- Colete feedback e sugest√µes\n\n# FERRAMENTAS\n\n## agendamentos\n**Quando usar:** Para verificar disponibilidade, criar, reagendar ou cancelar consultas.\n\n**Diretrizes de uso:**\n- **Consultas:** Sempre verificar disponibilidade antes de confirmar\n- **Confirma√ß√£o:** Sempre confirmar dados antes de finalizar agendamento\n- **Hor√°rios:** Apresentar op√ß√µes claras e organizadas\n- **Reagendamento:** Verificar pol√≠tica de cancelamento\n\n## medicos\n**Quando usar:** Para buscar m√©dicos por especialidade, localiza√ß√£o ou disponibilidade.\n\n## clinicas\n**Quando usar:** Para buscar cl√≠nicas por regi√£o, especialidades ou conv√™nios aceitos.\n\n# CONTEXTO\n\nO AgendMed √© uma plataforma completa de gest√£o m√©dica que conecta pacientes, m√©dicos e cl√≠nicas de forma inteligente. Nossa miss√£o √© simplificar o acesso √† sa√∫de atrav√©s da tecnologia.\n\n## Funcionalidades Principais:\n\n### Para Pacientes:\n- Busca de m√©dicos por especialidade e localiza√ß√£o\n- Agendamento online 24/7\n- Hist√≥rico de consultas\n- Lembretes autom√°ticos\n- Avalia√ß√µes e coment√°rios\n- Telemedicina integrada\n\n### Para M√©dicos:\n- Agenda digital inteligente\n- Gest√£o de pacientes\n- Prontu√°rio eletr√¥nico\n- Controle financeiro\n- Relat√≥rios e analytics\n- Integra√ß√£o com conv√™nios\n\n### Para Cl√≠nicas:\n- Gest√£o multi-profissional\n- Controle de salas e equipamentos\n- Faturamento automatizado\n- Dashboard executivo\n- Integra√ß√£o com laborat√≥rios\n- Sistema de filas inteligente\n\n## Planos Dispon√≠veis:\n\n### Plano B√°sico (Gratuito):\n- At√© 50 agendamentos/m√™s\n- Agenda b√°sica\n- Suporte por email\n\n### Plano Profissional (R$ 49,90/m√™s):\n- Agendamentos ilimitados\n- Prontu√°rio eletr√¥nico\n- Relat√≥rios avan√ßados\n- Suporte priorit√°rio\n- Telemedicina\n\n### Plano Cl√≠nica (R$ 149,90/m√™s):\n- M√∫ltiplos profissionais\n- Gest√£o financeira completa\n- Integra√ß√£o com conv√™nios\n- Dashboard executivo\n- Suporte dedicado\n\n## Informa√ß√µes de Contato:\n- **Site:** https://agendmed.com.br\n- **Suporte:** suporte@agendmed.com.br\n- **WhatsApp:** (11) 99999-9999\n- **Hor√°rio de atendimento:** 8h √†s 18h (seg-sex)\n\n# REGRAS ESPEC√çFICAS\n\n## O QUE VOC√ä DEVE FAZER:\n- Usar linguagem natural, coloquial e acolhedora\n- Ser transparente sobre funcionalidades e limita√ß√µes\n- Sempre confirmar informa√ß√µes importantes\n- Direcionar para canais apropriados quando necess√°rio\n- Coletar feedback para melhorias\n\n## O QUE VOC√ä N√ÉO DEVE FAZER:\n- Dar conselhos m√©dicos\n- Prometer funcionalidades n√£o dispon√≠veis\n- Compartilhar dados pessoais de outros usu√°rios\n- Fazer diagn√≥sticos ou recomenda√ß√µes de tratamento\n- Agendar consultas sem confirma√ß√£o do paciente\n\n## FLUXOS ESPEC√çFICOS:\n\n### Novo Paciente:\n1. Apresenta√ß√£o da plataforma\n2. Explica√ß√£o do processo de cadastro\n3. Ajuda na busca de m√©dicos\n4. Orienta√ß√£o sobre primeiro agendamento\n\n### Paciente Existente:\n1. Identifica√ß√£o do problema/necessidade\n2. Acesso direto √†s funcionalidades\n3. Suporte t√©cnico se necess√°rio\n\n### M√©dico Interessado:\n1. Apresenta√ß√£o dos benef√≠cios\n2. Demonstra√ß√£o das funcionalidades\n3. Informa√ß√µes sobre planos\n4. Agendamento de demonstra√ß√£o\n\n### Suporte T√©cnico:\n1. Identifica√ß√£o do problema\n2. Tentativa de resolu√ß√£o imediata\n3. Escala√ß√£o para suporte t√©cnico se necess√°rio\n4. Follow-up da resolu√ß√£o\n\nLembre-se: Voc√™ √© a primeira impress√£o do AgendMed. Seja sempre prestativa, profissional e humana!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [400, 128],
      "id": "ai-assistant-agendmed",
      "name": "Assistente IA AgendMed",
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials-id",
          "name": "OpenAI AgendMed"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('global').item.json.agendmed_api_url }}/appointments/check-availability",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.AGENDMED_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"date\": \"{{ $json.requested_date }}\",\n  \"doctorId\": \"{{ $json.doctor_id }}\",\n  \"clinicId\": \"{{ $json.clinic_id }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 200],
      "id": "check-availability",
      "name": "Verificar Disponibilidade"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('global').item.json.agendmed_api_url }}/appointments/create",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.AGENDMED_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"patientId\": \"{{ $('Buscar/Criar Paciente AgendMed').item.json.id }}\",\n  \"doctorId\": \"{{ $json.doctor_id }}\",\n  \"clinicId\": \"{{ $json.clinic_id }}\",\n  \"date\": \"{{ $json.appointment_date }}\",\n  \"time\": \"{{ $json.appointment_time }}\",\n  \"type\": \"{{ $json.appointment_type || 'consultation' }}\",\n  \"notes\": \"{{ $json.notes || '' }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1200, 200],
      "id": "create-appointment",
      "name": "Criar Agendamento"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('global').item.json.host_evo }}/message/sendText/{{ $('global').item.json.nomeinstancia_evo }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "={{ $('global').item.json.apikey_evo }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('global').item.json.telefone }}\",\n  \"text\": \"{{ $('Assistente IA AgendMed').item.json.content || $('Assistente IA AgendMed').item.json.text }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1600, 128],
      "id": "send-whatsapp-response",
      "name": "Enviar Resposta WhatsApp"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $('global').item.json.agendmed_api_url }}/doctors/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "specialty",
              "value": "={{ $json.specialty }}"
            },
            {
              "name": "location",
              "value": "={{ $json.location }}"
            },
            {
              "name": "insurance",
              "value": "={{ $json.insurance }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.AGENDMED_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 400],
      "id": "search-doctors",
      "name": "Buscar M√©dicos"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $('global').item.json.agendmed_api_url }}/clinics/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "specialty",
              "value": "={{ $json.specialty }}"
            },
            {
              "name": "location",
              "value": "={{ $json.location }}"
            },
            {
              "name": "insurance",
              "value": "={{ $json.insurance }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.AGENDMED_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 600],
      "id": "search-clinics",
      "name": "Buscar Cl√≠nicas"
    },
    {
      "parameters": {
        "content": "### AgendMed - Automa√ß√£o WhatsApp\n\nFluxo principal:\n1. Recebe mensagem via webhook\n2. Identifica/cria paciente no AgendMed\n3. Processa mensagem (texto/√°udio/imagem)\n4. Responde via IA contextualizada\n5. Executa a√ß√µes (agendamentos, buscas)\n6. Envia resposta via WhatsApp",
        "height": 400,
        "width": 600,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [-2600, -200],
      "typeVersion": 1,
      "id": "documentation-note",
      "name": "Documenta√ß√£o"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "global",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "global": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "Buscar/Criar Paciente AgendMed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar/Criar Paciente AgendMed": {
      "main": [
        [
          {
            "node": "Tipo da Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo da Mensagem": {
      "main": [
        [],
        [
          {
            "node": "Assistente IA AgendMed",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Assistente IA AgendMed": {
      "main": [
        [
          {
            "node": "Enviar Resposta WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-11-02T12:00:00.000Z",
      "updatedAt": "2024-11-02T12:00:00.000Z",
      "id": "agendmed-automation",
      "name": "AgendMed"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-11-02T12:00:00.000Z",
  "versionId": "agendmed-v2"
}